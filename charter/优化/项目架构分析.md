# 租船邮件AI分析系统 - 项目架构与工作逻辑分析

## 📋 项目概述

这是一个**租船邮件智能分析系统**，通过AI技术自动监控邮箱、解析租船相关邮件（船盘和货盘），并将结构化数据存储到数据库中，实现租船信息的自动化处理。

## 🏗️ 项目架构

### 1. 核心模块划分

```
charter/
├── charter_email_monitor_service.py    # 单邮箱实时监控服务
├── charter_service.py                  # 多用户定时解析服务
├── charter_private_service.py          # 私有邮箱监控服务
├── charter_utils.py                    # 工具函数库
├── config.py                           # 配置文件
├── db_utils.py                         # 数据库连接池
└── log_config.py                       # 日志配置
```

### 2. 服务模块详解

#### 2.1 `charter_email_monitor_service.py` - 单邮箱实时监控
- **功能**: 监控特定邮箱（opentonnages@hifleet.com），实时处理新邮件
- **工作方式**: 
  - 使用IMAP协议连接邮箱
  - 每60秒轮询检查新邮件（基于UID增量）
  - 实时解析并存储数据
- **特点**: 
  - 使用`last_seen_uid`跟踪已处理邮件
  - 数据标记为`is_public=1`（公开数据）

#### 2.2 `charter_service.py` - 多用户定时解析服务
- **功能**: 支持多用户邮箱的批量解析
- **工作方式**:
  - 定时任务调度（每小时:00, :10, :20, :30, :40, :50执行）
  - 从数据库读取用户配置（`charter_user_service_configuration`表）
  - 支持IMAP和POP3协议
  - 使用线程池并发处理（最多20个线程）
- **特点**:
  - 支持SM4加密的邮箱密码解密
  - 记录`last_parse_time`避免重复处理
  - 数据标记为`is_public=0`（私有数据）

#### 2.3 `charter_private_service.py` - 私有邮箱监控
- **功能**: 监控另一个特定邮箱（mytonnages@hifleet.com）
- **工作方式**: 与`charter_email_monitor_service.py`类似，但数据标记为`is_public=0`

#### 2.4 `charter_utils.py` - 工具函数库
包含大量辅助函数：
- **邮件处理**: `extract_reply()`, `desensitize_text()`, `clean_sender_name()`
- **数据清洗**: `sanitize_date()`, `clean_port()`, `clean_imo()`
- **AI调用**: `call_deepseek_api()`, `call_deepseek_region()`, `call_deepseek_shiptype()`
- **数据增强**: `generate_vessel_tags()`, `generate_cargo_tags()`, `classify_vessel_type()`
- **匹配算法**: `fuzzy_port_match()`, `check_date_overlap()`, `parse_dwt_range()`
- **加密工具**: `Sm4Util`类（SM4加密/解密）

#### 2.5 `config.py` - 配置中心
- 数据库连接配置
- 邮箱SMTP配置
- AI提示词模板（`system_text`, `user_text`, `region_system`, `shiptype_system`）

## 🔄 核心工作流程

### 流程1: 邮件监控与获取

```
┌─────────────────┐
│  邮箱服务器     │
│  (IMAP/POP3)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  邮件解析       │
│  parse_email()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  提取邮件信息   │
│  (主题/正文/    │
│   发件人/日期)  │
└─────────────────┘
```

**关键代码**:
```python
# 解析邮件内容
email_data = parse_email(raw_email)
# 提取: from_name, from_email, date, subject, body
```

### 流程2: AI智能解析

```
┌─────────────────┐
│  邮件原始内容   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  内容预处理     │
│  - 提取回复部分 │
│  - 脱敏处理     │
│  - 截取前5000字 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  DeepSeek API   │
│  调用           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  JSON解析       │
│  - 意图识别     │
│  - 数据提取     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  结构化数据     │
│  - openvessels  │
│  - cargo        │
└─────────────────┘
```

**关键代码**:
```python
# 调用AI解析
data = call_deepseek_api(email_data['subject'] + "\n" + email_data['body'])
intent_list = data.get('intent')  # ['openvessels', 'cargo', 'unknown']
charter_data = data.get('data')   # 包含船盘和货盘数据
```

### 流程3: 数据增强与清洗

#### 3.1 船盘数据处理流程

```
┌─────────────────┐
│  AI解析的船盘   │
│  原始数据       │
└────────┬────────┘
         │
         ├─→ 船名清洗（去除MV前缀）
         ├─→ IMO验证与补全
         │   └─→ 如果缺失，调用Hifleet API查询
         ├─→ 港口区域识别（AI）
         ├─→ 船型标准化（AI）
         ├─→ 港口ID查询
         ├─→ 船龄计算
         ├─→ 标签生成（制裁风险、设备等）
         └─→ 船型分类（Mini Bulk, Handysize等）
```

**关键处理**:
- **IMO补全**: 如果邮件中IMO缺失，通过船名调用`https://api.hifleet.com/position/search/basicinfo/token`查询
- **港口增强**: 调用`call_deepseek_region()`识别港口所属区域和UN/LOCODE代码
- **船型标准化**: 调用`call_deepseek_shiptype()`将船型标准化
- **标签生成**: `generate_vessel_tags()`生成风险标签（制裁、PSC风险等）

#### 3.2 货盘数据处理流程

```
┌─────────────────┐
│  AI解析的货盘   │
│  原始数据       │
└────────┬────────┘
         │
         ├─→ 港口清洗与标准化
         ├─→ 港口区域识别（AI）
         ├─→ 港口ID查询
         └─→ 标签生成（货物类型、规模等）
```

### 流程4: 数据存储

#### 4.1 数据库表结构

**主要数据表**:

1. **`charter_parsed_emails_info`** - 已解析邮件记录
   - 记录每封邮件的元信息（发件人、主题、时间等）

2. **`charter_open_vessels`** - 船盘数据表
   - 存储船舶开放位置信息
   - 字段包括：船名、IMO、船型、载重吨、OPEN位置、OPEN日期、设备信息等
   - 关键字段：`is_duplicate`（是否重复）、`is_public`（是否公开）、`tags`（标签）

3. **`charter_cargo`** - 货盘数据表
   - 存储货物运输需求
   - 字段包括：客户名称、货物类型、装货港、卸货港、消约期、船型要求等

4. **`charter_user_service_configuration`** - 用户服务配置表
   - 存储用户邮箱配置（邮箱地址、密码、服务器、协议等）
   - 记录`last_parse_time`（上次解析时间）

#### 4.2 数据插入逻辑

```python
# 1. 先记录邮件信息
INSERT INTO charter_parsed_emails_info 
(email_user, subject, from_name, from_email, receive_time)

# 2. 处理船盘数据
if "openvessels" in intent_list:
    for vessel in charter_data["openvessels"]:
        # 数据清洗和增强
        # 插入船盘表
        INSERT INTO charter_open_vessels (...)

# 3. 处理货盘数据
if "cargo" in intent_list:
    for cargo in charter_data["cargo"]:
        # 数据清洗和增强
        # 插入货盘表
        INSERT INTO charter_cargo (...)
```

### 流程5: 去重处理

系统使用`mark_duplicates()`函数标记重复数据：

```sql
-- 船盘去重：基于邮箱、用户、船名、港口、发件人、邮件正文
UPDATE charter_open_vessels SET is_duplicate = 1
WHERE id NOT IN (
    SELECT MAX(id) FROM charter_open_vessels
    WHERE is_duplicate = 0
    GROUP BY email_users, user_id, vessel_name, open_port, 
             sender_name, sender_email, email_body
)

-- 货盘去重：基于邮箱、用户、客户名、港口、日期、发件人、邮件正文
UPDATE charter_cargo SET is_duplicate = 1
WHERE id NOT IN (
    SELECT MAX(id) FROM charter_cargo
    WHERE is_duplicate = 0
    GROUP BY email_users, user_id, acct_name, cargo_quantity,
             load_port, discharge_port, laycan_start, laycan_end,
             sender_name, sender_email, email_body
)
```

## 🧠 AI解析逻辑

### DeepSeek API调用

**系统提示词** (`system_text`):
- 定义三种意图：`cargo`（货盘）、`openvessels`（船盘）、`unknown`（其他）
- 详细说明需要提取的字段（船盘30+字段，货盘20+字段）
- 规定JSON返回格式

**用户提示词** (`user_text`):
- 包含邮件内容（前5000字符）
- 经过脱敏处理（邮箱、电话、公司名）

**返回格式**:
```json
{
  "intent": ["openvessels", "cargo"],
  "data": {
    "openvessels": [
      {
        "船名": "...",
        "IMO": "...",
        "船型": "...",
        "载重吨": 50000,
        ...
      }
    ],
    "cargo": [
      {
        "客户名称": "...",
        "货物种类": "...",
        "装货港": "...",
        ...
      }
    ]
  }
}
```

## 🔧 关键技术点

### 1. 邮件协议支持
- **IMAP**: 支持增量查询（基于UID）
- **POP3**: 支持最近100封邮件检查

### 2. 数据增强策略
- **IMO补全**: 通过船名+载重吨匹配Hifleet数据库
- **港口识别**: AI识别港口所属区域和UN/LOCODE代码
- **船型标准化**: AI将非标准船型转换为标准分类
- **标签生成**: 基于多数据源（船舶数据库、制裁数据库、PSC数据库）

### 3. 错误处理
- API调用重试机制（最多5次，延迟10秒）
- JSON解析容错（处理注释、None值等）
- 数据库连接池（30个连接，自动重试）

### 4. 性能优化
- 数据库连接池复用
- 线程池并发处理（最多20个线程）
- 定时任务分散执行（每小时6次）

## 📊 数据流向图

```
邮箱服务器
    │
    ├─→ charter_email_monitor_service.py (实时监控)
    │       └─→ charter_open_vessels (is_public=1)
    │
    ├─→ charter_service.py (定时批量)
    │       └─→ charter_open_vessels (is_public=0)
    │       └─→ charter_cargo (is_public=0)
    │
    └─→ charter_private_service.py (私有监控)
            └─→ charter_open_vessels (is_public=0)
```

## 🎯 业务价值

1. **自动化处理**: 无需人工阅读邮件，自动提取结构化数据
2. **实时性**: 监控服务实时处理新邮件（60秒轮询）
3. **准确性**: AI解析结合规则清洗，提高数据质量
4. **可扩展性**: 支持多用户、多邮箱配置
5. **数据增强**: 自动补充IMO、港口信息、风险标签等

## ⚠️ 注意事项

1. **API密钥**: 代码中包含DeepSeek API密钥，需要妥善保管
2. **数据库密码**: 多个数据库连接密码硬编码在代码中
3. **文件路径**: 部分路径为Windows格式（`E:\xwc\...`），需要适配
4. **匹配功能**: 船盘-货盘匹配功能已注释，可能需要启用

## 🔄 改进建议

1. **配置管理**: 将敏感信息（API密钥、数据库密码）移至环境变量或配置文件
2. **错误监控**: 增加更完善的错误监控和告警机制
3. **性能监控**: 添加处理时间、成功率等指标监控
4. **匹配算法**: 启用并优化船盘-货盘自动匹配功能
5. **日志优化**: 统一日志格式，便于问题排查

