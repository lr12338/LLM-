# 船舶报警识别Agent使用文档

## 1. 快速开始

### 1.1 安装依赖

确保已安装以下Python包：
```bash
pip install langchain langchain-openai langgraph typing-extensions
```

### 1.2 配置说明

确保 `config.py` 文件中的API密钥配置正确：
- `huoshan_api_key`: 火山方舟API密钥
- `huoshan_base_url`: API基础URL
- `huoshan_model_doubaoseed1_6flash`: 模型名称

### 1.3 基本使用

```python
from shipAlertAgent import create_ship_alert_workflow

# 创建工作流
app = create_ship_alert_workflow()

# 设置线程配置
thread_config = {"configurable": {"thread_id": "ship_alert_session_1"}}

# 准备输入数据
input_data = {
    "messages": [],
    "video_event_record_id": "1993846874922176512",
    "camera_name": "驾驶台",
    "events_type": "Calling",
    "snap_url": "https://static.hifleet.com/video_event/413601240/995e30e0-1673-409d-8d6f-bca169cd8b78.jpeg",
    "detection_result": {},
    "matched": 0,
    "reason": "",
    "route_key": ""
}

# 执行分析
result = app.invoke(input_data, config=thread_config)

# 查看结果
print(f"matched: {result.get('matched')}")
print(f"reason: {result.get('reason')}")
print(f"detection_result: {result.get('detection_result')}")
```

## 2. 输入参数说明

### 2.1 必需参数

| 参数名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `video_event_record_id` | str | 事件ID（唯一标识） | "1993846874922176512" |
| `camera_name` | str | 摄像头位置 | "驾驶台" 或 "主甲板" |
| `events_type` | str | 事件类型 | "Calling", "Smoking", "Driver-CloseEyes", "Smoke" |
| `snap_url` | str | 图片URL地址 | "https://static.hifleet.com/..." |

### 2.2 可选参数（初始状态）

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `messages` | list | [] | 消息历史（初始为空） |
| `detection_result` | dict | {} | 检测结果（初始为空） |
| `matched` | int | 0 | 判断结果（初始为0） |
| `reason` | str | "" | 判断原因（初始为空） |
| `route_key` | str | "" | 路由标识（初始为空） |

## 3. 支持的事件类型

### 3.1 驾驶台事件

#### Calling（打电话）
- **检测条件**：
  - `has_human_body`: 是否检测到人体特征
  - `hand_holding_phone`: 手部是否持有手机
  - `phone_near_ear_or_face`: 手机是否靠近耳朵/脸部
  - `landline_telephone`: 是否是有线电话
  - `upper_body_fully_visible`: 上半身是否清晰可见

#### Smoking（吸烟）
- **检测条件**：
  - `has_human_body`: 是否检测到人体特征
  - `hand_holding_cigarette`: 手部是否持有香烟
  - `smoke_visible`: 是否可见烟雾
  - `face_visible`: 人脸是否可见
  - `smoking_gesture`: 是否有吸烟动作

#### Driver-CloseEyes（闭眼）
- **检测条件**：
  - `has_human_body`: 是否检测到人体特征
  - `face_visible`: 人脸是否清晰可见
  - `eyes_closed`: 眼睛是否闭合
  - `eyes_closed_duration`: 闭眼持续时间
  - `driver_position`: 驾驶员位置是否正常

### 3.2 主甲板事件

#### Smoke（烟雾）
- **检测条件**：
  - `smoke_visible`: 是否可见烟雾
  - `smoke_density`: 烟雾密度（高/中/低/无）
  - `location_identifiable`: 位置是否可识别
  - `fire_source_visible`: 是否可见火源
  - `environment_clear`: 环境是否清晰

## 4. 输出结果说明

### 4.1 输出结构

```python
{
    "messages": [...],  # 消息历史
    "video_event_record_id": "...",  # 事件ID
    "camera_name": "...",  # 摄像头位置
    "events_type": "...",  # 事件类型
    "snap_url": "...",  # 图片URL
    "detection_result": {  # 检测结果
        "has_human_body": true,
        "hand_holding_phone": true,
        ...
        "reason": "判断原因",
        "content": "图片简述"
    },
    "matched": 1,  # 最终判断结果（1=真实报警，0=误识别）
    "reason": "综合判断原因",
    "route_key": "驾驶台_Calling"  # 路由标识
}
```

### 4.2 matched字段说明

- **matched = 1**：真实报警，需要处理
- **matched = 0**：误识别，可以忽略

## 5. 判断规则说明

### 5.1 Calling事件判断规则

1. 如果未检测到人体特征 → matched = 0
2. 如果检测到有线电话 → matched = 1
3. 如果检测到手持手机且靠近耳朵/脸部 → matched = 1
4. 其他情况 → matched = 0

### 5.2 Smoking事件判断规则

1. 如果未检测到人体特征 → matched = 0
2. 如果检测到手持香烟且有吸烟动作/烟雾 → matched = 1
3. 如果检测到手持香烟 → matched = 1
4. 其他情况 → matched = 0

### 5.3 Driver-CloseEyes事件判断规则

1. 如果未检测到人体特征或人脸不可见 → matched = 0
2. 如果检测到持续闭眼 → matched = 1
3. 如果检测到闭眼 → matched = 1
4. 其他情况 → matched = 0

### 5.4 Smoke事件判断规则

1. 如果检测到明显烟雾（高/中密度） → matched = 1
2. 如果检测到火源 → matched = 1
3. 如果检测到烟雾 → matched = 1
4. 其他情况 → matched = 0

## 6. 批量处理示例

参考 `batch_process.py` 文件，可以批量处理 `imgUrl.txt` 文件中的多个事件。

## 7. 自定义扩展

### 7.1 添加新的事件类型

1. 在 `PROMPT_TEMPLATES` 中添加新的提示词模板
2. 在 `result_judge_node` 中添加对应的判断规则
3. 确保 `route_key` 格式为 `{camera_name}_{events_type}`

### 7.2 修改判断规则

在 `result_judge_node` 函数中，找到对应的事件类型判断逻辑，修改条件即可。

### 7.3 自定义上传逻辑

修改 `upload_event_result` 工具函数，替换为实际的API调用。

## 8. 常见问题

### Q1: 模型返回的JSON格式不正确怎么办？
A: 系统会自动尝试从文本中提取JSON，如果提取失败，会在 `detection_result` 中记录错误信息和原始响应。

### Q2: 如何提高识别准确率？
A: 
- 优化提示词模板，使描述更精确
- 调整模型的temperature参数
- 根据实际数据调整判断规则

### Q3: 支持本地图片吗？
A: 当前版本仅支持图片URL，如需支持本地图片，可以修改 `task_node` 中的图片处理逻辑。

### Q4: 如何查看详细的执行过程？
A: 查看 `messages` 字段，其中包含了所有节点的执行消息。

## 9. 性能优化建议

1. **并发处理**：对于批量任务，可以使用多线程或异步处理
2. **缓存机制**：对于相同图片URL，可以缓存检测结果
3. **模型选择**：根据实际需求选择合适的模型（速度vs准确率）

## 10. 联系与支持

如有问题或建议，请联系开发团队。

